# Protecting against vulnerable images

Harbor ships with a vulnerability scanner called Clair, which allows us to check our image for published vulnerabilities ([CVEs](https://cve.mitre.org/about/faqs.html)) before deploying, and to make decisions based on the findings.

> Ensure you have completed step 2 sucessfully before proceeding

## Configure Harbor to use Clair

1. Turn on image scanning for the default library project.
    1. Open the Harbor UI.
    2. Select the `library` project, and then click the `Configuration` tab.
    3. Select `Prevent vulnerable images from running` and set the threshold to high. This will prevent vulnerable images with one or more `high` vulnerability CVEs from getting pulled from this registry.
    4. Set the option to scan on push.
1. If left alone, the registry will eventually pull the vulnerability database from the internet, however depending on bandwidth this can be a lengthy process. For ease of access, run the following script to load a pre-downloaded Clair database into the pods:  
`./deploy_db.sh`{{execute}}

## Build a Vulnerable Image
We have provided you with a vulnerable Dockerfile and test application to build and push to the harbour image registry

1. Login to the harbour image registry:  
`docker login -u admin -p kubecon1234 127.0.0.1:30002`{{execute}}
1. Build the demo-api image and push it into your local Harbor registry:  
`docker build . -t 127.0.0.1:30002/library/demo-api:vulnerable`{{execute}}  
`docker push 127.0.0.1:30002/library/demo-api:vulnerable`{{execute}}
1. In the Harbor UI, enter the library project and view the demo-api image. The vulnerability rating should be showing as `HIGH`, indicating that there is one or more strong vulnerabilities in the image.

## Deploy a vulnerable image

We have provided a sample YAML to deploy this demo-api to your cluster

1. Read the YAML check you understand the deployment and service:  
`cat demo-api.yaml`{{execute}}
1. Apply the YAMl to the cluster:  
`kubectl apply -f demo-api.yaml`{{execute}}
1. Check if it has deployed with:  
`kubectl get pods`
If you have configured harbor correctly, you will notice that the pod has an `ErrImagePull` or `ImagePullBackOff` error.
1. Investigate the reason for the pull failure with:  
`kubectl describe pods #pod-name`{{copy}}
The event log should show that the image was denied based on its high vulnerability.
    ```text
    Failed to pull image "192.168.99.100:30003/library/demo-api:vulnerable": rpc error: code = Unknown desc = Error response from daemon: unknown: The severity of vulnerability of the image: "high" is equal or higher than the threshold in project setting: "high".
    ```
## Fix and deploy secure images

To fix the image and get our app deployed, we need to update the Dockerfile with a secure base image.

1. In the Dockerfile, change the base image to `alpine:3.4`, then rebuild and push the demo-api image.  
`vi Dockerfile`{{execute}}  
`docker build . -t 127.0.0.1:30002/library/demo-api:secure`{{execute}}  
`docker push 127.0.0.1:30002/library/demo-api:secure`{{execute}}
1. Change the deployment yaml `demo-api.yaml` to reference your new secure image, with the secure tag and redeploy.  
`vi demo-api.yaml`{{execute}}  
`kubectl apply -f demo-api.yaml`{{execute}}

3. Check if the pod has come up now. It should as it is now less vulnerable so harbor will allow it to deploy.
